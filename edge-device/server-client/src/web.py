import threading
import time
from flask import Flask, render_template, jsonify, request, Response
import random

app = Flask(__name__, template_folder='templates',
            static_folder='static', static_url_path='/')
rgb_data = [{ 'name': 'r-value',
              'values':{
                'except':  [{'x': 1598850500111, 'y': 8.255385961269337},
                            {'x': 1598850501111, 'y': 8.522856658860768},
                            {'x': 1598850502111, 'y': 8.85224288300491},
                            {'x': 1598850503111, 'y': 8.203602150586137},
                            {'x': 1598850504111, 'y': 8.830985714653746},
                            {'x': 1598850505111, 'y': 8.648804185628615},
                            {'x': 1598850506111, 'y': 8.54365631703881},
                            {'x': 1598850507111, 'y': 8.183473493411935},
                            {'x': 1598850508111, 'y': 8.107250381815213},
                            {'x': 1598850509111, 'y': 8.674642595370756},
                            {'x': 1598850510111, 'y': 8.875834458275218},
                            {'x': 1598850511111, 'y': 8.104192236371079},
                            {'x': 1598850512111, 'y': 8.273510688961343},
                            {'x': 1598850513111, 'y': 8.698645044397763},
                            {'x': 1598850514111, 'y': 8.630132546505347},
                            {'x': 1598850515111, 'y': 8.19276234585974},
                            {'x': 1598850516111, 'y': 8.202379301534918},
                            {'x': 1598850517111, 'y': 8.888758703470918},
                            {'x': 1598850518111, 'y': 8.840359577742495},
                            {'x': 1598850519111, 'y': 8.965286133918756}],

                'actual':  [{'x': 1598850500111, 'y': 5.631470025269889},
                            {'x': 1598850501111, 'y': 5.80833150333066},
                            {'x': 1598850502111, 'y': 5.615057046709662},
                            {'x': 1598850503111, 'y': 5.608928585842969},
                            {'x': 1598850504111, 'y': 5.153605115523144},
                            {'x': 1598850505111, 'y': 5.438982653534119},
                            {'x': 1598850506111, 'y': 5.434254193425316},
                            {'x': 1598850507111, 'y': 5.233764563045739},
                            {'x': 1598850508111, 'y': 5.066078696056088},
                            {'x': 1598850509111, 'y': 5.402066058377414},
                            {'x': 1598850510111, 'y': 5.115167367142142},
                            {'x': 1598850511111, 'y': 5.569563848237927},
                            {'x': 1598850512111, 'y': 5.3771521799030895},
                            {'x': 1598850513111, 'y': 5.557674673748734},
                            {'x': 1598850514111, 'y': 5.779198450582005},
                            {'x': 1598850515111, 'y': 5.024568401355755},
                            {'x': 1598850516111, 'y': 5.999943168524271},
                            {'x': 1598850517111, 'y': 5.3633974314345725},
                            {'x': 1598850518111, 'y': 5.152136232686349},
                            {'x': 1598850519111, 'y': 5.497676337112302}]
              }
            },{ 'name': 'g-value',
              'values':{
                'except':  [{'x': 1598850500111, 'y': 8.255385961269337},
                            {'x': 1598850501111, 'y': 8.522856658860768},
                            {'x': 1598850502111, 'y': 8.85224288300491},
                            {'x': 1598850503111, 'y': 8.203602150586137},
                            {'x': 1598850504111, 'y': 8.830985714653746},
                            {'x': 1598850505111, 'y': 8.648804185628615},
                            {'x': 1598850506111, 'y': 8.54365631703881},
                            {'x': 1598850507111, 'y': 8.183473493411935},
                            {'x': 1598850508111, 'y': 8.107250381815213},
                            {'x': 1598850509111, 'y': 8.674642595370756},
                            {'x': 1598850510111, 'y': 8.875834458275218},
                            {'x': 1598850511111, 'y': 8.104192236371079},
                            {'x': 1598850512111, 'y': 8.273510688961343},
                            {'x': 1598850513111, 'y': 8.698645044397763},
                            {'x': 1598850514111, 'y': 8.630132546505347},
                            {'x': 1598850515111, 'y': 8.19276234585974},
                            {'x': 1598850516111, 'y': 8.202379301534918},
                            {'x': 1598850517111, 'y': 8.888758703470918},
                            {'x': 1598850518111, 'y': 8.840359577742495},
                            {'x': 1598850519111, 'y': 8.965286133918756}],

                'actual':  [{'x': 1598850500111, 'y': 5.631470025269889},
                            {'x': 1598850501111, 'y': 5.80833150333066},
                            {'x': 1598850502111, 'y': 5.615057046709662},
                            {'x': 1598850503111, 'y': 5.608928585842969},
                            {'x': 1598850504111, 'y': 5.153605115523144},
                            {'x': 1598850505111, 'y': 5.438982653534119},
                            {'x': 1598850506111, 'y': 5.434254193425316},
                            {'x': 1598850507111, 'y': 5.233764563045739},
                            {'x': 1598850508111, 'y': 5.066078696056088},
                            {'x': 1598850509111, 'y': 5.402066058377414},
                            {'x': 1598850510111, 'y': 5.115167367142142},
                            {'x': 1598850511111, 'y': 5.569563848237927},
                            {'x': 1598850512111, 'y': 5.3771521799030895},
                            {'x': 1598850513111, 'y': 5.557674673748734},
                            {'x': 1598850514111, 'y': 5.779198450582005},
                            {'x': 1598850515111, 'y': 5.024568401355755},
                            {'x': 1598850516111, 'y': 5.999943168524271},
                            {'x': 1598850517111, 'y': 5.3633974314345725},
                            {'x': 1598850518111, 'y': 5.152136232686349},
                            {'x': 1598850519111, 'y': 5.497676337112302}]
              }
            }]



def update_values():
    while True:
        t = time.time()
        for d in rgb_data:
            d['values']["except"].pop(0)
            d['values']["except"].append({'x': int(t * 1000),'y':random.random()*10})
            d['values']["actual"].pop(0)
            d['values']["actual"].append({'x': int(t * 1000),'y':random.random()*10})
            # print(d)
        time.sleep(1)


@app.route('/')
def index():
    return render_template('hello.html')


@app.route('/chart')
def chart():
    return render_template('chart.html')


@app.route('/hello')
def hello_world():
    return 'Hello, World!'


@app.route('/values')
def get_values():
    return jsonify(rgb_data)


@app.route('/update', methods=['POST'])
def update_value():
    response = Response()
    r_value = request.form['r-value']
    g_value = request.form['g-value']
    if r_value != None and g_value != None and r_value != '' and g_value != '':
        print(r_value, g_value)
        response.data='OK!'
    else:
        response.status_code = 400
    return response


if __name__ == '__main__':
    try:
        t = threading.Thread(target=update_values)
        t.setDaemon(True)
        # 启动线程
        t.start()
        app.run(debug=True)
    except KeyboardInterrupt:
        print("Stop now! Goodbye!")
    except:
        print('Error!')